---
layout: single
title:  "[t101-3기] Terraform 스터디 2주차"
tags:
  - terraform

categories:
  - terraform
    
toc: true
toc_sticky: true
---

본 시리즈는 T101(테라폼으로 시작하는 IaC) 3기 스터디 진행 내용입니다. 
테라폼으로 시작하는 IaC 책을 기반으로 내용 정리하였습니다.

![](https://image.yes24.com/goods/119179333/XL) 

[도서정보](https://www.yes24.com/Product/Goods/119179333)

[실습 코드](https://github.com/terraform101)
 
### 데이터 소스란?

데이터 소스를 테라폼으로 정의되지 않은 외부 리소스 또는 저장된 정보를 테라폼 내에서 참조할 때 사용한다

- 데이터 소스 블록은 'data' 로 시작하고 구후,  ‘데이터 소스 유형을 정의하게 된다. ← Resource 블록 정의와 유사 - [[참고: local 프로바이더 - data sources]](https://registry.terraform.io/providers/hashicorp/local/latest/docs/data-sources/file#required)
    - 데이터 소스 유형은 첫 번째 _를 기준으로 앞은 프로바이더 이름, 뒤는 프로바이더에서 제공하는 리소스 유형을 의미한다.
    - 데이터 소스 유형을 선언한 뒤에는 고유한 이름을 붙인다. 리소스의 이름과 마찬가지로 이름은 동일한 유형에 대한 식별자 역할을 하므로 중복될 수 없다.
    - 이름 뒤에는 데이터 소스 유형에 대한 구성 인수들은 { } 안에 선언한다. 인수가 필요하지 않은 유형도 있지만, 그때에도 { } 는 입력한다

```
data "local_file" "abc" {
  filename = "${path.module}/abc.txt"
}
```
- 데이터 소스를 정의할 때 사용 가능한 메타인수는 다음과 같다.
    - **depends_on** : 종속성을 선언하며, 선언된 구성요소와의 생성 시점에 대해 정의
    - **count** : 선언된 개수에 따라 여러 리소스를 생성
    - **for_each** : map 또는 set 타입의 데이터 배열의 값을 기준으로 여러 리소스를 생성
    - **lifecycle** : 리소스의 수명주기 관리

```
# Terraform Code
data "<리소스 유형>" "<이름>" {
  <인수> = <값>
}

# 데이터 소스 참조
data.<리소스 유형>.<이름>.<속성>

# 예시
# Declare the data source

data "aws_availability_zones" "available" {
  state = "available"
}
resource "aws_subnet" "primary" {
  availability_zone = data.aws_availability_zones.available.names[0]
  # e.g. ap-northeast-2a
}
resource "aws_subnet" "secondary" {
  availability_zone = data.aws_availability_zones.available.names[1]
  # e.g. ap-northeast-2b
}
```
![참고문서](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones)

### [도전과제1] 위 리전 내에서 사용 가능한 가용영역 목록 가져오기를 사용한 VPC 리소스 생성 실습 진행, 또는 관련된 데이터 소스를 사용한 실습한 내용을 글로 작성.

리전 내에서 사용 가능한 가용영역 목록 가져오기를 사용한 vpc와 subnet 만들기 

```
# Declare the data source
data "aws_availability_zones" "available" {
  state = "available"
}
resource "aws_subnet" "primary" {
  availability_zone = data.aws_availability_zones.available.names[0]
  # e.g. ap-northeast-2a
}
resource "aws_subnet" "secondary" {
  availability_zone = data.aws_availability_zones.available.names[1]
  # e.g. ap-northeast-2b
}
```
하지만 아래와 같은 에러가 발생한다.
읽어보면 aws_subnet을 위해서는 vpc_id라는 argument값이 필요한데, 정의 되지 않아서 에러가 발생한다는 것


```
 ~/De/practice/terraform/t1/3.5  master <3>2 +3 !5 ?243  terraform plan
╷
│ Error: Missing required argument
│ 
│   on main.tf line 5, in resource "aws_subnet" "primary":
│    5: resource "aws_subnet" "primary" {
│ 
│ The argument "vpc_id" is required, but no definition was found.
╵
╷
│ Error: Missing required argument
│ 
│   on main.tf line 9, in resource "aws_subnet" "secondary":
│    9: resource "aws_subnet" "secondary" {
│ 
│ The argument "vpc_id" is required, but no definition was found.
```
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/vpc
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/subnet 

이를 해결해주기 위해 어떤 argument가 필요한지 위 링크에서 찾아본다

```
data "aws_availability_zones" "available" {
  state = "available"
}

#vpc 
resource "aws_vpc" "main" {
  cidr_block       = "10.0.0.0/16"
  instance_tenancy = "default"

  tags = {
    Name = "main"
  }
}

#subnet
resource "aws_subnet" "primary" {
  availability_zone = data.aws_availability_zones.available.names[0]
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"

  tags = {
    Name = "Main"
  }
}

resource "aws_subnet" "second" {
  availability_zone = data.aws_availability_zones.available.names[0]
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.2.0/24"

  tags = {
    Name = "Main"
  }
}
```

### 입력 변수 Variable

```
# variable 블록 선언의 예
variable "<이름>" {
 <인수> = <값>
}

variable "image_id" {
 type = string
}
```
테라폼 예약 변수 이름으로 사용 불가능 : source, version, providers, count, for_each, lifecycle, depends_on, locals

- 기본 유형
    - string : 글자 유형
    - number : 숫자 유형
    - bool : true 또는 false
    - any : 명시적으로 모든 유형이 허용됨을 표시
- 집합 유형
    - list (<유형>): 인덱스 기반 집합
    - map (<유형>): 값 = 속성 기반 집합이며 키값 기준 정렬
    - set (<유형>): 값 기반 집합이며 정렬 키값 기준 정렬
    - object ({<인수 이름>=<유형>, …})
    - tuple ([<유형>, …])
- list와 set은 선언하는 형태가 비슷하지만 참조 방식이 인덱스와 키로 각각 차이가 있고, map와 set의 경우 선언된 값이 정렬되는 특징을 가진다.
